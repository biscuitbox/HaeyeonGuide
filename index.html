<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>해연중 안내 - 3장 사진 (상단 목록/contain/고정)</title>

  <style>
    html, body { height: 100%; margin: 0; }
    #wrap { position: relative; width: 100vw; height: 100vh; overflow: hidden; background:#111; }

    /* 상단 바 */
    #topbar{
      position:absolute; left: 10px; right: 10px; top: 10px;
      z-index: 10;
      display: grid;
      gap: 8px;
    }
    .bar{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 8px;
      border-radius: 14px;
      background: rgba(15,15,18,.62);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      align-items: center;
    }
    .btn{
      border: 0;
      border-radius: 999px;
      padding: 7px 10px;
      font-weight: 900;
      cursor: pointer;
      background: rgba(255,255,255,.10);
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      font-size: 12px;
      line-height: 1;
      user-select: none;
      white-space: nowrap;
    }
    .btn.active{
      background:#2f7cff;
      outline:2px solid rgba(47,124,255,.55);
    }

    /* 뷰포트 */
    #stage{
      position:absolute;
      inset: 0;
      overflow: hidden;
      touch-action: none; /* 확대/스크롤 제스처 최소화 */
    }

    /* 이미지+마커 덩어리 (이동=카메라 이동 효과) */
    #world{
      position:absolute;
      left:0; top:0;
      will-change: transform;
      transition: transform 420ms ease;
      z-index: 1;
    }

    #photo{
      display:block;
      max-width:none;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none; /* 사진 클릭은 stage에서 받음 */
    }

    /* 마커 레이어(필수) */
    #markersLayer{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      pointer-events:none;
    }

    /* 마커(글자만 둥둥) */
    .txt-marker{
      position:absolute;
      transform: translate(-50%, -50%);
      color:#fff;
      font-weight:900;
      font-size:18px;
      letter-spacing:-0.5px;
      text-shadow:0 2px 10px rgba(0,0,0,.95);
      white-space:nowrap;
      user-select:none;
      pointer-events:none; /* 마커 클릭 막음 */
    }

    /* 토스트(방문자용 안내용만) */
    #toast{
      position:absolute; left:12px; bottom:12px;
      background:rgba(0,0,0,.65); color:#fff;
      padding:10px 12px; border-radius:12px; font-size:12px;
      opacity:0; transform:translateY(8px); transition:.18s ease;
      pointer-events:none; z-index: 20;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
    }
    #toast.show{ opacity:1; transform:translateY(0); }

    @media (max-width: 420px) {
      .btn { padding: 6px 9px; font-size: 11px; }
      .bar { padding: 7px; }
    }
  </style>
</head>

<body>
<div id="wrap">
  <!-- 상단 바: 사진 탭 + 장소 목록 -->
  <div id="topbar">
    <div class="bar" id="sceneTabs"></div>
    <div class="bar" id="placeTabs"></div>
  </div>

  <div id="stage">
    <div id="world">
      <img id="photo" alt="school photo" />
      <div id="markersLayer"></div>
    </div>
  </div>

  <div id="toast"></div>
</div>

<script>
  /********************************************************************
   * 1) 사진 설정 (업로드 파일명: images/1.jpg, 2.jpg, 3.jpg)
   ********************************************************************/
  const SCENES = [
    { id: 'img1', name: '전경', src: 'images/1.jpg' },
    { id: 'img2', name: '구관', src: 'images/2.jpg' },
    { id: 'img3', name: '신관', src: 'images/3.jpg' },
  ];

  /********************************************************************
   * 2) 장소 목록 (추가/삭제는 여기만)
   ********************************************************************/
   const PLACES = [
    '교장실',
    '교무실',
    '행정실',
    '상담실',
    '보건실',
    '제1과학실',
    '제2과학실',
    '무한상상실',    
    '컴퓨터실',
    '정보모둠실',
    '방송실',
    '정보실',
    '가사실',
    '강당(체육관, 급식실)',
    '무용실(소강당)',
    '음악실',
    '진로활동실',
    '학생자치실',
    '도서관, 영어실, 미술실'    
  ];

  /********************************************************************
   * 3) ✅ 장소별 데이터: "어느 사진(scene)인지 + 좌표(x,y) 1세트"
   *    - 좌표는 0~1 비율(이미지 기준)
   *    - scene은 'img1' | 'img2' | 'img3'
   *
   *    좌표를 아직 모르거나 표시하지 않을 곳은 x/y를 null로 두면 됩니다.
   ********************************************************************/
  const PLACE_DATA = {
    '교장실': { scene: 'img3', x: 0.5, y: 0.5 },
    '교무실': { scene: 'img1', x: null, y: null },
    '행정실': { scene: 'img1', x: null, y: null },
    '상담실': { scene: 'img1', x: null, y: null },
    '보건실': { scene: 'img1', x: null, y: null },
    '제1과학실': { scene: 'img1', x: null, y: null },
    '제2과학실': { scene: 'img1', x: null, y: null },
    '무한상상실': { scene: 'img1', x: null, y: null },
    '컴퓨터실': { scene: 'img1', x: null, y: null },
    '정보모둠실': { scene: 'img1', x: null, y: null },
    '방송실': { scene: 'img1', x: null, y: null },
    '정보실': { scene: 'img1', x: null, y: null },
    '가사실': { scene: 'img1', x: null, y: null },
    '강당(체육관), 급식실': { scene: 'img1', x: null, y: null },
    '무용실(소강당)': { scene: 'img1', x: null, y: null },
    '음악실': { scene: 'img1', x: null, y: null },
    '진로활동실': { scene: 'img1', x: null, y: null },
    '학생자치실': { scene: 'img1', x: null, y: null },
    '도서관, 영어실, 미술실': { scene: 'img1', x: null, y: null }
    // 예) '도서관': { scene: 'img1', x: 0.33, y: 0.62 },
  };


  /********************************************************************
   * 4) PLACES만 늘려도 누락 방지되게 자동 보정
   ********************************************************************/
  function normalizePlaceData() {
    const sceneIds = new Set(SCENES.map(s => s.id));
    for (const place of PLACES) {
      if (!PLACE_DATA[place]) PLACE_DATA[place] = { scene: SCENES[0].id, x: null, y: null };
      const d = PLACE_DATA[place];
      if (!sceneIds.has(d.scene)) d.scene = SCENES[0].id;
      if (typeof d.x !== 'number') d.x = null;
      if (typeof d.y !== 'number') d.y = null;
    }
  }
  normalizePlaceData();

  /********************************************************************
   * 5) DOM/상태
   ********************************************************************/
  const $photo = document.getElementById('photo');
  const $world = document.getElementById('world');
  const $markersLayer = document.getElementById('markersLayer');
  const $sceneTabs = document.getElementById('sceneTabs');
  const $placeTabs = document.getElementById('placeTabs');
  const $toast = document.getElementById('toast');
  const $stage = document.getElementById('stage');

  let currentSceneId = SCENES[0].id;

  function toast(msg) {
    $toast.textContent = msg;
    $toast.classList.add('show');
    clearTimeout(toast._t);
    toast._t = setTimeout(() => $toast.classList.remove('show'), 900);
  }

  /********************************************************************
   * 6) contain 레이아웃 + 이동(moveTo)
   ********************************************************************/
  function layoutContain() {
    const sw = $stage.clientWidth;
    const sh = $stage.clientHeight;
    const iw = $photo.naturalWidth;
    const ih = $photo.naturalHeight;
    if (!iw || !ih) return;

    const scale = Math.min(sw / iw, sh / ih); // contain
    const w = iw * scale;
    const h = ih * scale;

    $photo.style.width = `${w}px`;
    $photo.style.height = `${h}px`;
    $world.style.width = `${w}px`;
    $world.style.height = `${h}px`;
  }

  function moveTo(x, y) {
    const sw = $stage.clientWidth;
    const sh = $stage.clientHeight;

    const w = $photo.getBoundingClientRect().width;
    const h = $photo.getBoundingClientRect().height;

    const cx = x * w;
    const cy = y * h;

    let tx = (sw / 2) - cx;
    let ty = (sh / 2) - cy;

    // contain에서는 world가 stage보다 작을 수 있으니 "작으면 가운데 고정"
    if (w <= sw) tx = (sw - w) / 2;
    else {
      const minTx = sw - w;
      tx = Math.min(0, Math.max(minTx, tx));
    }

    if (h <= sh) ty = (sh - h) / 2;
    else {
      const minTy = sh - h;
      ty = Math.min(0, Math.max(minTy, ty));
    }

    $world.style.transform = `translate(${tx}px, ${ty}px)`;
  }

  /********************************************************************
   * 7) 마커 렌더링: "현재 사진"에 속한 장소만 표시
   ********************************************************************/
  function clearMarkers() { $markersLayer.innerHTML = ''; }

  function addMarker(label, x, y) {
    const el = document.createElement('div');
    el.className = 'txt-marker';
    el.textContent = label;
    el.style.left = `${x * 100}%`;
    el.style.top  = `${y * 100}%`;
    $markersLayer.appendChild(el);
  }

  function renderMarkersForCurrentScene() {
    clearMarkers();
    for (const place of PLACES) {
      const d = PLACE_DATA[place];
      if (!d) continue;
      if (d.scene !== currentSceneId) continue;
      if (d.x == null || d.y == null) continue;
      addMarker(place, d.x, d.y);
    }
  }

  function firstDefinedPosInScene(sceneId) {
    for (const place of PLACES) {
      const d = PLACE_DATA[place];
      if (d && d.scene === sceneId && d.x != null && d.y != null) return d;
    }
    return null;
  }

  /********************************************************************
   * 8) 상단 탭 렌더링
   ********************************************************************/
  function renderSceneTabs() {
    $sceneTabs.innerHTML = '';
    for (const s of SCENES) {
      const b = document.createElement('button');
      b.className = 'btn' + (s.id === currentSceneId ? ' active' : '');
      b.textContent = s.name;
      b.onclick = () => switchScene(s.id);
      $sceneTabs.appendChild(b);
    }
  }

  function renderPlaceTabs() {
    $placeTabs.innerHTML = '';
    for (const place of PLACES) {
      const b = document.createElement('button');
      b.className = 'btn';
      b.textContent = place;

      b.onclick = async () => {
        const d = PLACE_DATA[place];
        if (!d || d.x == null || d.y == null) {
          toast(`${place}: 좌표 미지정`);
          return;
        }
        // 장소가 속한 사진으로 자동 전환 후 이동
        if (d.scene !== currentSceneId) await switchScene(d.scene);
        moveTo(d.x, d.y);
        toast(`${place}로 이동`);
      };

      $placeTabs.appendChild(b);
    }
  }

  /********************************************************************
   * 9) 이미지 로드 / 장면 전환
   ********************************************************************/
  function loadImage(sceneId) {
    const scene = SCENES.find(s => s.id === sceneId);
    return new Promise((resolve, reject) => {
      $photo.onload = () => resolve();
      $photo.onerror = reject;
      $photo.src = scene.src;
    });
  }

  async function switchScene(sceneId) {
    if (sceneId === currentSceneId) return;
    currentSceneId = sceneId;

    renderSceneTabs();
    await loadImage(sceneId);

    layoutContain();
    renderMarkersForCurrentScene();

    const first = firstDefinedPosInScene(sceneId);
    if (first) moveTo(first.x, first.y);
    else moveTo(0.5, 0.5);
  }

  /********************************************************************
   * 10) ✅ 개발자용 좌표 찍기 모드 (PC 전용 가정)
   *     - Shift + 클릭일 때만 동작 (기본 OFF)
   *     - 출력: Console + 클립보드 자동 복사
   ********************************************************************/
  function screenToRatioXY(clientX, clientY) {
    // stage 안에서 실제 이미지가 그려진 영역(world의 크기/위치)을 기준으로 비율좌표 계산
    const imgRect = $photo.getBoundingClientRect();
    const rx = (clientX - imgRect.left) / imgRect.width;
    const ry = (clientY - imgRect.top) / imgRect.height;

    // 이미지 바깥(여백) 클릭이면 null
    if (rx < 0 || rx > 1 || ry < 0 || ry > 1) return null;
    return { x: rx, y: ry };
  }

  async function copyToClipboard(text) {
    try {
      await navigator.clipboard.writeText(text);
    } catch {
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }
  }

  $stage.addEventListener('click', async (e) => {
    // ✅ Shift 안 누르면 아무 것도 안 함 (방문자에게는 기능이 사실상 없음)
    if (!e.shiftKey) return;

    const pos = screenToRatioXY(e.clientX, e.clientY);
    if (!pos) {
      console.log('[좌표] 이미지 밖(여백)을 클릭했습니다.');
      toast('이미지 영역을 Shift+클릭하세요');
      return;
    }

    const x = Number(pos.x.toFixed(6));
    const y = Number(pos.y.toFixed(6));

    // 콘솔 출력 (place 설정에 바로 복붙하기 좋게)
    const snippet = `{ scene: '${currentSceneId}', x: ${x}, y: ${y} }`;
    console.log(`[좌표] scene=${currentSceneId}  x=${x}, y=${y}`);
    console.log(`[복붙용] ${snippet}`);

    // 자동 복사 (편의)
    await copyToClipboard(snippet);

    // 방문자에게 과하게 노출될 필요 없지만, 작업자는 알 수 있게 아주 짧게만
    toast('좌표 복사됨(Shift+클릭)');
  });

  /********************************************************************
   * 11) 리사이즈
   ********************************************************************/
  window.addEventListener('resize', () => {
    layoutContain();
    moveTo(0.5, 0.5);
  });

  /********************************************************************
   * 12) 초기 시작
   ********************************************************************/
  (async function init() {
    renderSceneTabs();
    renderPlaceTabs();
    await loadImage(currentSceneId);

    layoutContain();
    renderMarkersForCurrentScene();

    const first = firstDefinedPosInScene(currentSceneId);
    if (first) moveTo(first.x, first.y);
    else moveTo(0.5, 0.5);
  })();
</script>
</body>
</html>